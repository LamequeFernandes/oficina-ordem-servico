graph TB
    subgraph CLIENT["Cliente"]
        C1[Aplicação Web / Mobile]
        C2[API Gateway / Postman]
    end

    subgraph AUTH["Auth Service (Lambda)"]
        Lambda[AWS Lambda\nGeração de JWT]
    end

    subgraph K8S["Kubernetes EKS — namespace: oficina"]
        LB[LoadBalancer\nPort 8001]

        subgraph POD["oficina-ordem-servico"]
            direction TB
            subgraph PRES["Presentation Layer"]
                R1[/usuarios]
                R2[/usuarios/clientes]
                R3[/usuarios/funcionarios]
                R4[/veiculos]
                R5[/ordens_servico]
            end

            subgraph APP["Application Layer"]
                UC1[CriarOrdemServicoUseCase]
                UC2[ConsultarOrdemServicoUseCase]
                UC3[AlterarStatusOrdemServicoUseCase]
                UC4[RemoverServicoUseCase]
            end

            subgraph DOMAIN["Domain Layer"]
                E1[OrdemServico]
                E2[Veiculo]
                E3[Cliente / Funcionario]
                VO[Value Objects: CPF, CNPJ]
            end

            subgraph INFRA["Infrastructure Layer"]
                REP1[OrdemServicoRepository]
                REP2[VeiculoRepository]
                REP3[UsuarioRepository]
                MAP[Mappers Entity ↔ Model]
            end

            subgraph CORE["Core"]
                SEC[security.py\nJWT Validation]
                UTILS[utils.py\nHTTP para Execução]
                DB[database.py\nSQLAlchemy Session]
            end
        end

        HPA[HPA\nMin 1 / Max 5\nCPU 70%]
        SEC_K8S[Secret: ordem-servico-secrets]
    end

    subgraph DB_LAYER["AWS RDS — MySQL"]
        DB_OS[(oficina_ordem_servico\nusuarios · veiculos\nordens_servico)]
    end

    subgraph EXECUCAO["Microsserviço Execução\n:8002"]
        FILA[POST /fila-execucao\nPOST /iniciar-diagnostico\nPOST /finalizar-diagnostico\nPOST /iniciar-reparo\nPOST /finalizar-reparo]
    end

    subgraph CICD["CI/CD — GitHub Actions"]
        T[pytest + coverage ≥ 80%]
        BI[docker build]
        PUS[push DockerHub\nlamequesao/oficina-ordem-servico]
        DEP[kubectl apply\nrolling update]
    end

    %% Request flow
    C1 -->|Bearer JWT| LB
    C2 -->|Bearer JWT| LB
    C1 -->|POST /auth| Lambda
    Lambda -->|JWT| C1
    LB --> PRES

    %% Internal flow
    PRES --> APP
    APP --> DOMAIN
    APP --> INFRA
    INFRA --> CORE
    CORE --> DB_OS

    %% Integration
    UTILS -->|HTTP| FILA

    %% K8s
    HPA -.->|escala| POD
    SEC_K8S -.->|env vars| POD

    %% CI/CD
    T --> BI --> PUS --> DEP --> POD

    classDef layer fill:#1e3a5f,stroke:#4a90d9,color:#fff
    classDef ext fill:#2d6a4f,stroke:#52b788,color:#fff
    classDef db fill:#6b2737,stroke:#c9184a,color:#fff
    classDef k8s fill:#1a4971,stroke:#5ba4cf,color:#fff
    classDef cicd fill:#3d405b,stroke:#81b29a,color:#fff

    class PRES,APP,DOMAIN,INFRA,CORE layer
    class FILA,Lambda ext
    class DB_OS db
    class LB,HPA,SEC_K8S k8s
    class T,BI,PUS,DEP cicd
