name: CI/CD Pipeline

on:
  push:
  pull_request:
    branches: 
      - main
    types:
      - closed

jobs:
  build-and-test:
    if: github.event.pull_request.merged == true && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: oficina_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt 
        pip install pytest pytest-cov pymysql coverage

    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -proot --silent; then
            echo "MySQL is up"
            break
          fi
          echo "Waiting for MySQL..."
          sleep 2
        done

    - name: Initialize schema
      run: mysql -h 127.0.0.1 -uroot -proot oficina_test < ${{ github.workspace }}/scripts/create_db_oficina.sql

    - name: Run tests with coverage
      env:
        USER_DB: root
        PASSWORD_DB: root
        HOST_DB: 127.0.0.1
        PORT_DB: 3306
        DATABASE: oficina_test
        SECRET_KEY: test_secret_key
        ALGORITHM: HS256
      run: |
        pytest --cov=./ --cov-report=xml --cov-report=html --cov-fail-under=80 --maxfail=1 --disable-warnings -q

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30

    - name: Check coverage
      run: |
        # Extrai a porcentagem de cobertura do arquivo XML
        COVERAGE_PERCENT=$(python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        coverage = root.attrib['line-rate']
        print(f'{float(coverage)*100:.2f}%')
        ")
        echo "Coverage: $COVERAGE_PERCENT"
        
        # Verifica se a cobertura é pelo menos 80%
        python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        coverage = float(root.attrib['line-rate'])
        print(f'Coverage: {coverage*100:.2f}%')
        if coverage < 0.8:
            print('ERROR: Coverage below 80%')
            exit(1)
        else:
            print('SUCCESS: Coverage meets 80% requirement')
        "

    # BUILD AND PUSH DOCKER IMAGE
    - name: Build Docker image
      run: docker build -t lamequesao/oficina-api:${{ github.sha }} .

    - name: Push to Docker Hub
      run: |
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u lamequesao --password-stdin
        docker push lamequesao/oficina-api:${{ github.sha }}

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name oficina-fase3-eks --region us-east-1

    - name: Create Namespace
      run: |
        kubectl apply -f k8s/namespace.yaml

    - name: Substitute Env Variables in Secret and Apply
      run: |
        sed -i "s|<USER_DB>|${{ secrets.DB_USERNAME }}|g" k8s/secret.yaml
        sed -i "s|<PASSWORD_DB>|${{ secrets.DB_PASSWORD }}|g" k8s/secret.yaml
        sed -i "s|<HOST_DB>|${{ secrets.RDS_ENDPOINT }}|g" k8s/secret.yaml
        sed -i "s|<PORT_DB>|3306|g" k8s/secret.yaml
        sed -i "s|<DATABASE>|oficina_fase1|g" k8s/secret.yaml
        sed -i "s|<SECRET_KEY>|${{ secrets.SECRET_KEY }}|g" k8s/secret.yaml
        sed -i "s|<ALGORITHM>|HS256|g" k8s/secret.yaml
        sed -i "s|<JWT_ISSUER>|oficina-auth|g" k8s/secret.yaml
        sed -i "s|<JWT_AUDIENCE>|oficina-api|g" k8s/secret.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/deployment.yaml -n oficina
        kubectl apply -f k8s/service.yaml -n oficina

    - name: Verify Deployment
      run: |
        # Aguarda até 5 minutos pelo deployment ficar pronto
        kubectl rollout status deployment/oficina-api -n oficina --timeout=300s
        
        # Mostra status final
        echo "=== PODS ==="
        kubectl get pods -n oficina
        
        echo "=== SERVICES ==="
        kubectl get svc -n oficina
        
        echo "=== ENDPOINT ==="
        kubectl get svc oficina-api -n oficina -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'

    - name: Notify Deployment Success
      run: echo "Deployment to Kubernetes cluster 'oficina-fase3-eks' completed successfully."
